---
title: "Protein Overlap"
output:
  html_document:
    echo: no
  pdf_document: default
---

```{r set_options, echo=FALSE, message=FALSE}
require(knitr)
opts_chunk$set(echo = FALSE)

```


Protein overlap among results of 6600_64w of:

1. Spectronaut  
1. PeakView  
1. Skyline  
1. OpenSWATH  
1. DIAumpire  

Peptide identifications of other software tools are almost completely covered by Spectronaut. 

```{r loadlibs}

loadLibrary <- function(x) 
{
  if(!require(x, character.only=T, quietly = T, warn.conflicts=F)) 
  { 
    install.packages(x); library(x, character.only=T, warn.conflicts=F) 
  } 
}

loadLibrary("VennDiagram")
loadLibrary("tidyr")
loadLibrary("dplyr")
loadLibrary("ggplot2")

```


```{r loadFiles}

diaump.file <- "/Users/napedro/github_prj/swath-evaluation-manuscript/benchmarks/draft.v2/dataanalysis_TOF6600_64w/input/DIAumpire_r1.tsv"
spectronaut.file <- "/Users/napedro/github_prj/swath-evaluation-manuscript/benchmarks/draft.v2/dataanalysis_TOF6600_64w/input/Spectronaut_r2.tsv"
skyline.file <- "/Users/napedro/github_prj/swath-evaluation-manuscript/benchmarks/draft.v2/dataanalysis_TOF6600_64w/input/Skyline_r2.tsv"
peakview.file <- "/Users/napedro/github_prj/swath-evaluation-manuscript/benchmarks/draft.v2/dataanalysis_TOF6600_64w/input/PeakView_r2.tsv"
openswath.file <- "/Users/napedro/github_prj/swath-evaluation-manuscript/benchmarks/draft.v2/dataanalysis_TOF6600_64w/input/OpenSWATH_r2.tsv"

diaump <- read.table(diaump.file, header=T, sep="\t", stringsAsFactors=F)
spectronaut <- read.table(spectronaut.file, header=T, sep="\t", stringsAsFactors=F)
skyline <- read.table(skyline.file, header=T, sep="\t", stringsAsFactors=F)
peakview <- read.table(peakview.file, header=T, sep="\t", stringsAsFactors=F)
openswath <- read.table(openswath.file, header=T, sep="\t", stringsAsFactors=F)

```

Parse protein IDs from each software and ungroup them. There is not an easy way to deal with protein groups: they are not equivalent from one software to the other. As a rough approach, we can consider _all_ proteins of a group as identified. This is going to be a pesimistic approach for the protein overlap among software tools.

```{r parseIDs}

spectronaut <- spectronaut %>% 
    mutate( proteinID = substring(proteinID, first=4, last=nchar(proteinID))) %>%
    mutate( proteins = strsplit(proteinID, split="/")) %>%
    unnest(proteins) %>%
    mutate( protein = gsub("\\|", "", regmatches(proteins, gregexpr("\\|.*?\\|", proteins))) ) %>%
    select(-proteins) %>% 
    distinct(protein) %>% 
    group_by(protein) %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

spectronaut.id <- spectronaut %>%
    select(protein) %>%
    mutate(Spectronaut = TRUE)

diaump <- diaump %>% 
    mutate( proteins = strsplit(proteinID, split=";")) %>%
    unnest(proteins) %>%
    mutate( protein = gsub("\\|", "", regmatches(proteins, gregexpr("\\|.*?\\|", proteins))) ) %>%
    select(-proteins) %>% 
    distinct(protein) %>% 
    group_by(protein) %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

diaump.id <- diaump %>%
    select(protein) %>%
    mutate(DIAumpire = TRUE)

skyline <- skyline %>% 
    mutate( proteins = strsplit(proteinID, split="/")) %>%
    unnest(proteins) %>%
    filter(nchar(proteins) > 2) %>%
    mutate( protein = gsub("\\|", "", regmatches(proteins, gregexpr("\\|.*?\\|", proteins))) ) %>%
    select(-proteins) %>% 
    distinct(protein) %>% 
    group_by(protein) %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

skyline.id <- skyline %>%
    select(protein) %>%
    mutate(Skyline = TRUE)

peakview <- peakview %>% 
    mutate( proteins = strsplit(proteinID, split="/")) %>%
    unnest(proteins) %>%
    filter(nchar(proteins) > 2) %>%
    mutate( protein = gsub("\\|", "", regmatches(proteins, gregexpr("\\|.*?\\|", proteins))) ) %>%
    select(-proteins) %>% 
    distinct(protein) %>% 
    group_by(protein) %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

peakview.id <- peakview %>%
    select(protein) %>%
    mutate(PeakView = TRUE)


openswath <- openswath %>% 
    mutate( proteins = strsplit(proteinID, split="/")) %>%
    unnest(proteins) %>%
    filter(nchar(proteins) > 2) %>%
    mutate( protein = gsub("\\|", "", regmatches(proteins, gregexpr("\\|.*?\\|", proteins))) ) %>%
    select(-proteins) %>% 
    distinct(protein) %>% 
    group_by(protein) %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

openswath.id <- openswath %>%
    select(protein) %>%
    mutate(OpenSWATH = TRUE)


proteinoverlap <- merge(spectronaut.id, diaump.id, by="protein", all=T)
proteinoverlap <- merge(proteinoverlap, peakview.id, by="protein", all=T)
proteinoverlap <- merge(proteinoverlap, skyline.id, by="protein", all=T)
proteinoverlap <- merge(proteinoverlap, openswath.id, by="protein", all=T)

proteinoverlap[is.na(proteinoverlap)] <- FALSE

#List of proteins present in all tools
commonproteins <- proteinoverlap %>% (filter(Spectronaut == T & 
                                            PeakView    == T & 
                                            OpenSWATH   == T & 
                                            Skyline     == T & 
                                            DIAumpire   == T))

commonproteins.list <- commonproteins$protein
write.table(commonproteins.list, file="list_common_proteins.txt", sep="\t", row.names = F, col.names = F, quote = F)
```


We are interested on how many proteins of all library-based tools are not covered by Spectronaut:

```{r}
l <- venn.diagram(
                x = list(
                    Spectronaut = unlist(proteinoverlap %>% filter(Spectronaut == T) %>% select(protein)),
                    PeakView = unlist(proteinoverlap %>% filter(PeakView == T) %>% select(protein)),
                    OpenSWATH = unlist(proteinoverlap %>% filter(OpenSWATH == T) %>% select(protein)),
                    Skyline = unlist(proteinoverlap %>% filter(Skyline == T) %>% select(protein))
                    ),
                filename = "Figure5C.tiff",
                fontfamily="Arial",
                fill=c("yellow", "red", "green", "cyan"),
                cex=1.5, cat.cex=1.1, cat.dist=0.07
                #,category.names = rep("", 4)
                )

#nrow(proteinoverlap %>% filter(OpenSWATH == T))
```


The overlap between all software tools:

```{r}

l <-  venn.diagram(
                x = list(
                    DIA_Umpire = unlist(proteinoverlap %>% filter(DIAumpire == T) %>% select(protein)),
                    Spectronaut = unlist(proteinoverlap %>% filter(Spectronaut == T) %>% select(protein)),
                    PeakView = unlist(proteinoverlap %>% filter(PeakView == T) %>% select(protein)),
                    OpenSWATH = unlist(proteinoverlap %>% filter(OpenSWATH == T) %>% select(protein)),
                    Skyline = unlist(proteinoverlap %>% filter(Skyline == T) %>% select(protein))
                    ), 
                filename = "ProteinOverlap_allTools.tiff",
                fill=c("blue", "yellow", "red", "green", "cyan"),
                cex=1, cat.cex=1.1, cat.dist=0.07)

```


We then check the overlap between proteins identified in all library-based tools and DIA-Umpire: 

```{r overlap}


venn.plot <- venn.diagram(
    x = list(
        library_based = unlist(proteinoverlap %>% filter(Spectronaut == T | PeakView == T |  Skyline == T | OpenSWATH == T) %>% select(protein)),
        DIA_Umpire = unlist(proteinoverlap %>% filter(DIAumpire == T) %>% select(protein))
        ),
    fontfamily="Arial",
    filename = "Figure5D.tiff",
    fill=c("yellow", rgb(0,191/255,196/255)),
    cex=1.5, cat.cex=1.1, cat.dist=0.07,
    category.names = c("Library-based", "DIA-Umpire")  # rep("", 2)
    )

               
venn.plot <- venn.diagram(
    x = list(
        Spectronaut = unlist(proteinoverlap %>% filter(Spectronaut == T ) %>% select(protein)),
        DIA_Umpire = unlist(proteinoverlap %>% filter(DIAumpire == T) %>% select(protein))
        ),
    filename = "Figure5D_onlySpectronaut.tiff",
    col = "transparent",
    fill = c("red", "blue"),
    alpha = 0.5,
    #label.col = c("darkred", "white", "darkblue", "white",
    # "white", "white", "darkgreen"),
    cex = 1.5,
    fontfamily = "serif",
    fontface = "bold",
    cat.default.pos = "text",
    cat.col = c("darkred", "darkblue"),
    cat.cex = 1.5,
    cat.fontfamily = "serif",
    cat.dist = c(0.03, 0.03),
    cat.pos = c(-20,5)
    )


diaump.only.id <- (proteinoverlap %>% filter(Spectronaut == F & Skyline == F & PeakView == F & OpenSWATH == F & DIAumpire == T))$protein

```

There are only `r length(diaump.only.id)` proteins reported in DIA-Umpire that were not detected in Spectronaut. If we plot the intensities of these proteins (in blue) compared to the intensities of the proteins detected in both tools (in red) we observe that they are in the low range. 


```{r intensities}
diaump.only.id <- (proteinoverlap %>% filter(Spectronaut == F & Skyline == F & PeakView == F & OpenSWATH == F & DIAumpire == T))$protein
diaump <- diaump %>% 
        mutate( onlyDIAump = ifelse(protein %in% diaump.only.id, T, F) ) 

p <- ggplot(diaump, aes(x = log10(meanIntensity)))
p <- p + theme_classic() + theme(text = element_text(size=25))
p <- p + xlab(expression('log'[10]('average Intensity'))) + ylab('number of proteins')
p <- p + geom_histogram(aes(fill = onlyDIAump), position = "dodge" )
p <- p + facet_grid(facets= . ~ specie)

print(p)
ggsave(filename="Figure5E.pdf", plot=p, width=7, height=7)
```

