---
title: "Peptide Overlap"
output:
  html_document:
    echo: no
  pdf_document: default
---


```{r set_options, echo=FALSE, message=FALSE}
require(knitr)
opts_chunk$set(echo = FALSE)

```


Peptide overlap among results of 6600_64w of:

1. Spectronaut  
1. SWATH2.0  
1. Skyline  
1. OpenSWATH  
1. DIAumpire  

Peptide identifications of other software tools are almost completely covered by Spectronaut. 

```{r loadlibs}

loadLibrary <- function(x) 
{
  if(!require(x, character.only=T, quietly = T, warn.conflicts=F)) 
  { 
    install.packages(x); library(x, character.only=T, warn.conflicts=F) 
  } 
}

loadLibrary("VennDiagram")
loadLibrary("tidyr")
loadLibrary("dplyr")
loadLibrary("ggplot2")

```


```{r loadFiles}

diaump.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/DIAumpire_peptides_r1.tsv"
spectronaut.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/Spectronaut_peptides_r2.tsv"
skyline.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/Skyline_peptides_r2.tsv"
peakview.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/PeakView_peptides_r2.tsv"
openswath.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/OpenSWATH_peptides_r2.tsv"

diaump <- read.table(diaump.file, header=T, sep="\t", stringsAsFactors=F)
spectronaut <- read.table(spectronaut.file, header=T, sep="\t", stringsAsFactors=F)
skyline <- read.table(skyline.file, header=T, sep="\t", stringsAsFactors=F)
peakview <- read.table(peakview.file, header=T, sep="\t", stringsAsFactors=F)
openswath <- read.table(openswath.file, header=T, sep="\t", stringsAsFactors=F)

```

Parse sequence IDs from each software. _CAREFUL_: Sequence modifications reported differently!!!!

```{r parseIDs}

spectronaut <- spectronaut %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

spectronaut$sequenceID <- gsub("\\[Oxi\\]", "\\(UniMod:35\\)", spectronaut$sequenceID)
spectronaut$sequenceID <- gsub("\\[CAM\\]", "\\(UniMod:4\\)",  spectronaut$sequenceID)

spectronaut.id <- spectronaut %>%
    select(sequenceID) %>%
    mutate(Spectronaut = TRUE)

diaump <- diaump %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

diaump$sequenceID <- gsub("\\[15\\.995\\(M\\)\\]M", "M\\(UniMod:35\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[57\\.021\\(C\\)\\]C", "C\\(UniMod:4\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[-17\\.027\\(Q\\)\\]Q", "Q\\(UniMod:28\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[-18\\.011\\(E\\)\\]E", "E\\(UniMod:27\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[39\\.995\\(C\\)\\]C", "C\\(UniMod:26\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]A", "A\\(UniMod:1\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]M", "M\\(UniMod:1\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]C", "C\\(UniMod:1\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]D", "D\\(UniMod:1\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]E", "E\\(UniMod:1\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]G", "G\\(UniMod:1\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]P", "P\\(UniMod:1\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]S", "S\\(UniMod:1\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]T", "T\\(UniMod:1\\)", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[42\\.011\\(N-term\\)\\]V", "V\\(UniMod:1\\)", diaump$sequenceID)

diaump.id <- diaump %>%
    select(sequenceID) %>%
    mutate(DIAumpire = TRUE)

skyline <- skyline %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

skyline$sequenceID <- gsub("\\[\\+16\\]", "\\(UniMod:35\\)", skyline$sequenceID)
skyline$sequenceID <- gsub("\\[\\+57\\]", "\\(UniMod:4\\)",  skyline$sequenceID)

skyline.id <- skyline %>%
    select(sequenceID) %>%
    mutate(Skyline = TRUE)

peakview <- peakview %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

peakview$sequenceID <- gsub("\\[Oxi\\]", "\\(UniMod:35\\)", peakview$sequenceID)
peakview$sequenceID <- gsub("\\[CAM\\]", "\\(UniMod:4\\)",  peakview$sequenceID)

peakview.id <- peakview %>%
    select(sequenceID) %>%
    mutate(SWATH2.0 = TRUE)


openswath <- openswath %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

#openswath$sequenceID <- gsub("\\(UniMod:35\\)", "\\[Oxi\\]", openswath$sequenceID)
#openswath$sequenceID <- gsub("\\(UniMod:4\\)", "\\[CAM\\]", openswath$sequenceID)

openswath.id <- openswath %>%
    select(sequenceID) %>%
    mutate(OpenSWATH = TRUE)


common.sequences <- merge(spectronaut.id, diaump.id, by="sequenceID", all=T)
common.sequences <- merge(common.sequences, peakview.id, by="sequenceID", all=T)
common.sequences <- merge(common.sequences, skyline.id, by="sequenceID", all=T)
common.sequences <- merge(common.sequences, openswath.id, by="sequenceID", all=T)

common.sequences[is.na(common.sequences)] <- FALSE

# write list of common peptides (complete cases)
peptides.all.tools <- common.sequences %>% 
                        filter( Spectronaut == T & 
                                Skyline     == T & 
                                SWATH2.0    == T & 
                                OpenSWATH   == T & 
                                DIAumpire   == T) %>%
                        select(sequenceID)

write.table(peptides.all.tools, "peptides_in_all_tools.tsv", 
            sep="\t", col.names = F, row.names = F, quote = F)

```


We are interested on how many sequences of all library-based tools are not covered by Spectronaut:

```{r}

l <- venn.diagram(
                x = list(
                    Spectronaut = unlist(common.sequences %>% filter(Spectronaut == T) %>% select(sequenceID)),
                    SWATH2.0 = unlist(common.sequences %>% filter(SWATH2.0 == T) %>% select(sequenceID)),
                    OpenSWATH = unlist(common.sequences %>% filter(OpenSWATH == T) %>% select(sequenceID)),
                    Skyline = unlist(common.sequences %>% filter(Skyline == T) %>% select(sequenceID))
                    ),
                filename = "overlap_libbased.tiff",
                fill=c("yellow", "red", "green", "cyan"),
                cex=1, cat.cex=1.1, cat.dist=0.07
                )

l <- venn.diagram(
                x = list(
                    Spectronaut = unlist(common.sequences %>% filter(Spectronaut == T) %>% select(sequenceID)),
                    SWATH2.0 = unlist(common.sequences %>% filter(SWATH2.0 == T) %>% select(sequenceID)),
                    OpenSWATH = unlist(common.sequences %>% filter(OpenSWATH == T) %>% select(sequenceID)),
                    DIAumpire = unlist(common.sequences %>% filter(DIAumpire == T) %>% select(sequenceID))
                    ),
                filename = "Figure5D_peptides_SP_PV_OS_DU.tiff",
                fill=c("yellow", "red", "green", "cyan"),
                cex=1, cat.cex=1.1, cat.dist=0.07
                )

#nrow(common.sequences %>% filter(OpenSWATH == T))
```


The overlap between all software tools:

```{r}

l <-  venn.diagram(
                x = list(
                    DIA_Umpire = unlist(common.sequences %>% filter(DIAumpire == T) %>% select(sequenceID)),
                    Spectronaut = unlist(common.sequences %>% filter(Spectronaut == T) %>% select(sequenceID)),
                    SWATH2.0 = unlist(common.sequences %>% filter(SWATH2.0 == T) %>% select(sequenceID)),
                    OpenSWATH = unlist(common.sequences %>% filter(OpenSWATH == T) %>% select(sequenceID)),
                    Skyline = unlist(common.sequences %>% filter(Skyline == T) %>% select(sequenceID))
                    ), 
                filename = "PeptideOverlap_allTools.tiff",
                fill=c("blue", "yellow", "red", "green", "cyan"),
                cex=1, cat.cex=1.1, cat.dist=0.07)

```


We then check the overlap between sequences identified in all library-based tools and DIA-Umpire: 

```{r seq.overlap}


venn.plot <- venn.diagram(
    x = list(
        library_based = unlist(common.sequences %>% 
                                   filter(Spectronaut == T | 
                                              SWATH2.0 == T |  
                                              Skyline == T | 
                                              OpenSWATH == T) %>% select(sequenceID)),
        DIA_Umpire = unlist(common.sequences %>% filter(DIAumpire == T) %>% select(sequenceID))
        ),
    filename = "overlap_libbased_diaumpire.tiff",
    col = "transparent",
    fill = c("red", "blue"),
    alpha = 0.5,
    #label.col = c("darkred", "white", "darkblue", "white",
    # "white", "white", "darkgreen"),
    cex = 1.5,
    fontfamily = "serif",
    fontface = "bold",
    cat.default.pos = "text",
    cat.col = c("darkred", "darkblue"),
    cat.cex = 1.5,
    cat.fontfamily = "serif",
    cat.dist = c(0.03, 0.03),
    cat.pos = c(-20,5)
    )

diaump.only <- common.sequences %>% 
                filter(Spectronaut == F & 
                           Skyline == F & 
                          SWATH2.0 == F & 
                         OpenSWATH == F & 
                         DIAumpire == T)

diaump.only.nrow <- nrow(diaump.only)

```

There are `r diaump.only.nrow` sequences reported in DIA-Umpire that were not detected in any other tool. If we plot the intensities of these sequences (in blue) compared to the intensities of the sequences detected in several tools (in red) we observe that they are in the low range. 


```{r seq.intensities}
diaump.only.id <- diaump.only$sequenceID

write.table(diaump.only.id, file = "peptides.DIA-Umpire.only.tsv",
            sep="\t", col.names = F, row.names = F, quote = F)

diaump <- diaump %>% 
        mutate( onlyDIAump = ifelse(sequenceID %in% diaump.only.id, T, F) ) 

p <- ggplot(diaump, aes(x = log10(meanIntensity)))
p <- p + theme_classic() 
p <- p + xlab(expression('log'[10]('average Intensity'))) + ylab('number of sequences')
p <- p + geom_histogram(aes(fill = onlyDIAump), position = "dodge" )
p <- p + facet_grid(facets= . ~ specie)

print(p)
ggsave(filename="Figure3C_peptides.pdf", plot=p, width=7, height=7)
```

