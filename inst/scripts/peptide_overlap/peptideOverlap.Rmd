---
title: "Sequence Overlap"
output:
  html_document:
    echo: no
  pdf_document: default
---


```{r set_options, echo=FALSE, message=FALSE}
require(knitr)
opts_chunk$set(echo = FALSE)

```


Sequence overlap among results of 6600_64w of:

1. Spectronaut  
1. PeakView  
1. Skyline  
1. OpenSWATH  
1. DIAumpire  

Peptide identifications of other software tools are almost completely covered by Spectronaut. 

```{r loadlibs}

loadLibrary <- function(x) 
{
  if(!require(x, character.only=T, quietly = T, warn.conflicts=F)) 
  { 
    install.packages(x); library(x, character.only=T, warn.conflicts=F) 
  } 
}

loadLibrary("VennDiagram")
loadLibrary("tidyr")
loadLibrary("dplyr")
loadLibrary("ggplot2")

```


```{r loadFiles}

diaump.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/DIAumpire_peptides_r1.tsv"
spectronaut.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/Spectronaut_peptides_r2.tsv"
skyline.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/Skyline_peptides_r2.tsv"
peakview.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/PeakView_peptides_r2.tsv"
openswath.file <- "/Users/napedro/Dropbox/PAPER_SWATHbenchmark_prv/output.from.softwares/draft.v2/dataanalysis_TOF6600_64w/input/OpenSWATH_peptides_r2.tsv"

diaump <- read.table(diaump.file, header=T, sep="\t", stringsAsFactors=F)
spectronaut <- read.table(spectronaut.file, header=T, sep="\t", stringsAsFactors=F)
skyline <- read.table(skyline.file, header=T, sep="\t", stringsAsFactors=F)
peakview <- read.table(peakview.file, header=T, sep="\t", stringsAsFactors=F)
openswath <- read.table(openswath.file, header=T, sep="\t", stringsAsFactors=F)

```

Parse sequence IDs from each software. _CAREFUL_: Sequence modifications reported differently!!!!

```{r parseIDs}

spectronaut <- spectronaut %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

spectronaut.id <- spectronaut %>%
    select(sequenceID) %>%
    mutate(Spectronaut = TRUE)

diaump <- diaump %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

diaump$sequenceID <- gsub("\\[15\\.995\\(M\\)\\]M", "M\\[Oxi\\]", diaump$sequenceID)
diaump$sequenceID <- gsub("\\[57\\.021\\(C\\)\\]M", "M\\[CAM\\]", diaump$sequenceID)

diaump.id <- diaump %>%
    select(sequenceID) %>%
    mutate(DIAumpire = TRUE)

skyline <- skyline %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

skyline$sequenceID <- gsub("\\[\\+16\\]", "\\[Oxi\\]", skyline$sequenceID)
skyline$sequenceID <- gsub("\\[\\+57\\]", "\\[CAM\\]", skyline$sequenceID)

skyline.id <- skyline %>%
    select(sequenceID) %>%
    mutate(Skyline = TRUE)

peakview <- peakview %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

peakview.id <- peakview %>%
    select(sequenceID) %>%
    mutate(PeakView = TRUE)


openswath <- openswath %>% rowwise() %>%
    mutate( meanIntensity = mean(c(A1, A2, A3, B1, B2, B3), na.rm=T))

openswath$sequenceID <- gsub("\\(UniMod:35\\)", "\\[Oxi\\]", openswath$sequenceID)
openswath$sequenceID <- gsub("\\(UniMod:4\\)", "\\[CAM\\]", openswath$sequenceID)

openswath.id <- openswath %>%
    select(sequenceID) %>%
    mutate(OpenSWATH = TRUE)


common.sequences <- merge(spectronaut.id, diaump.id, by="sequenceID", all=T)
common.sequences <- merge(common.sequences, peakview.id, by="sequenceID", all=T)
common.sequences <- merge(common.sequences, skyline.id, by="sequenceID", all=T)
common.sequences <- merge(common.sequences, openswath.id, by="sequenceID", all=T)

common.sequences[is.na(common.sequences)] <- FALSE
```


We are interested on how many sequences of all library-based tools are not covered by Spectronaut:

```{r}

A = nrow(common.sequences %>% filter(Spectronaut == T))
B = nrow(common.sequences %>% filter(PeakView == T))
C = nrow(common.sequences %>% filter(Skyline == T))
D = nrow(common.sequences %>% filter(OpenSWATH == T))
E = nrow(common.sequences %>% filter(DIAumpire == T))


AB = nrow(common.sequences %>% filter(Spectronaut == T & PeakView == T))
AC = nrow(common.sequences %>% filter(Spectronaut == T & Skyline == T))
AD = nrow(common.sequences %>% filter(Spectronaut == T & OpenSWATH == T))
AE = nrow(common.sequences %>% filter(Spectronaut == T & DIAumpire == T))
BC = nrow(common.sequences %>% filter(PeakView == T & Skyline == T))
BD = nrow(common.sequences %>% filter(PeakView == T & OpenSWATH == T))
BE = nrow(common.sequences %>% filter(PeakView == T & DIAumpire == T))
CD = nrow(common.sequences %>% filter(Skyline == T & OpenSWATH == T))
CE = nrow(common.sequences %>% filter(Skyline == T & DIAumpire == T))
DE = nrow(common.sequences %>% filter(OpenSWATH == T & DIAumpire == T))
    
ABC = nrow(common.sequences %>% filter(Spectronaut == T & PeakView == T &  Skyline == T))
ABD = nrow(common.sequences %>% filter(Spectronaut == T & PeakView == T &  OpenSWATH == T))
ABE = nrow(common.sequences %>% filter(Spectronaut == T & PeakView == T &  DIAumpire == T))
ACD = nrow(common.sequences %>% filter(Spectronaut == T & Skyline == T & OpenSWATH == T))
ACE = nrow(common.sequences %>% filter(Spectronaut == T & Skyline == T & DIAumpire == T))
ADE = nrow(common.sequences %>% filter(Spectronaut == T & OpenSWATH == T & DIAumpire == T))
BCD = nrow(common.sequences %>% filter(PeakView == T &  Skyline == T & OpenSWATH == T))
BDE = nrow(common.sequences %>% filter(PeakView == T & OpenSWATH == T & DIAumpire == T))
BCE = nrow(common.sequences %>% filter(PeakView == T &  Skyline == T & DIAumpire == T))
CDE = nrow(common.sequences %>% filter(Skyline == T & OpenSWATH == T & DIAumpire == T))

ABCD = nrow(common.sequences %>% filter(Spectronaut == T & PeakView == T &  Skyline == T & OpenSWATH == T))
ABCE = nrow(common.sequences %>% filter(Spectronaut == T & PeakView == T &  Skyline == T & DIAumpire == T))
ABDE = nrow(common.sequences %>% filter(Spectronaut == T & PeakView == T &  OpenSWATH == T & DIAumpire == T))
ACDE = nrow(common.sequences %>% filter(Spectronaut == T & Skyline == T & OpenSWATH == T & DIAumpire == T))
BCDE = nrow(common.sequences %>% filter(PeakView == T &  Skyline == T & OpenSWATH == T & DIAumpire == T))

ABCDE = nrow(common.sequences %>% filter(Spectronaut == T & PeakView == T &  Skyline == T & OpenSWATH == T & DIAumpire == T))

l <- venn.diagram(
                x = list(
                    Spectronaut = unlist(common.sequences %>% filter(Spectronaut == T) %>% select(sequenceID)),
                    PeakView = unlist(common.sequences %>% filter(PeakView == T) %>% select(sequenceID)),
                    OpenSWATH = unlist(common.sequences %>% filter(OpenSWATH == T) %>% select(sequenceID)),
                    Skyline = unlist(common.sequences %>% filter(Skyline == T) %>% select(sequenceID))
                    ),
                filename = "Figure5D_peptides.tiff",
                fill=c("yellow", "red", "green", "cyan"),
                cex=1, cat.cex=1.1, cat.dist=0.07
                )

l <- venn.diagram(
                x = list(
                    Spectronaut = unlist(common.sequences %>% filter(Spectronaut == T) %>% select(sequenceID)),
                    PeakView = unlist(common.sequences %>% filter(PeakView == T) %>% select(sequenceID)),
                    OpenSWATH = unlist(common.sequences %>% filter(OpenSWATH == T) %>% select(sequenceID)),
                    DIAumpire = unlist(common.sequences %>% filter(DIAumpire == T) %>% select(sequenceID))
                    ),
                filename = "Figure5D_peptides_SP_PV_OS_DU.tiff",
                fill=c("yellow", "red", "green", "cyan"),
                cex=1, cat.cex=1.1, cat.dist=0.07
                )

#nrow(common.sequences %>% filter(OpenSWATH == T))
```


The overlap between all software tools:

```{r}

l <-  venn.diagram(
                x = list(
                    DIA_Umpire = unlist(common.sequences %>% filter(DIAumpire == T) %>% select(sequenceID)),
                    Spectronaut = unlist(common.sequences %>% filter(Spectronaut == T) %>% select(sequenceID)),
                    PeakView = unlist(common.sequences %>% filter(PeakView == T) %>% select(sequenceID)),
                    OpenSWATH = unlist(common.sequences %>% filter(OpenSWATH == T) %>% select(sequenceID)),
                    Skyline = unlist(common.sequences %>% filter(Skyline == T) %>% select(sequenceID))
                    ), 
                filename = "PeptideOverlap_allTools.tiff",
                fill=c("blue", "yellow", "red", "green", "cyan"),
                cex=1, cat.cex=1.1, cat.dist=0.07)

```


We then check the overlap between sequences identified in all library-based tools and DIA-Umpire: 

```{r seq.overlap}


venn.plot <- venn.diagram(
    x = list(
        library_based = unlist(common.sequences %>% filter(Spectronaut == T | PeakView == T |  Skyline == T | OpenSWATH == T) %>% select(sequenceID)),
        DIA_Umpire = unlist(common.sequences %>% filter(DIAumpire == T) %>% select(sequenceID))
        ),
    filename = "Figure5E_peptides.tiff",
    col = "transparent",
    fill = c("red", "blue"),
    alpha = 0.5,
    #label.col = c("darkred", "white", "darkblue", "white",
    # "white", "white", "darkgreen"),
    cex = 1.5,
    fontfamily = "serif",
    fontface = "bold",
    cat.default.pos = "text",
    cat.col = c("darkred", "darkblue"),
    cat.cex = 1.5,
    cat.fontfamily = "serif",
    cat.dist = c(0.03, 0.03),
    cat.pos = c(-20,5)
    )


venn.plot <- venn.diagram(
    x = list(
        Spectronaut = unlist(common.sequences %>% filter(Spectronaut == T ) %>% select(sequenceID)),
        DIA_Umpire = unlist(common.sequences %>% filter(DIAumpire == T) %>% select(sequenceID))
        ),
    filename = "Figure5E_peptides_onlySpectronaut.tiff",
    col = "transparent",
    fill = c("red", "blue"),
    alpha = 0.5,
    #label.col = c("darkred", "white", "darkblue", "white",
    # "white", "white", "darkgreen"),
    cex = 1.5,
    fontfamily = "serif",
    fontface = "bold",
    cat.default.pos = "text",
    cat.col = c("darkred", "darkblue"),
    cat.cex = 1.5,
    cat.fontfamily = "serif",
    cat.dist = c(0.03, 0.03),
    cat.pos = c(-20,5)
    )



diaump.only.nrow <- nrow(common.sequences %>% filter(Spectronaut == F & Skyline == F & PeakView == F & OpenSWATH == F & DIAumpire == T))

```

There are `r B -AB` sequences reported in DIA-Umpire that were not detected in any other tool. If we plot the intensities of these sequences (in blue) compared to the intensities of the sequences detected in several tools (in red) we observe that they are in the low range. 


```{r seq.intensities}
diaump.only.id <- (common.sequences %>% filter(Spectronaut == F & Skyline == F & PeakView == F & OpenSWATH == F & DIAumpire == T))$sequenceID
diaump <- diaump %>% 
        mutate( onlyDIAump = ifelse(sequenceID %in% diaump.only.id, T, F) ) 

p <- ggplot(diaump, aes(x = log10(meanIntensity)))
p <- p + theme_classic() 
p <- p + xlab(expression('log'[10]('average Intensity'))) + ylab('number of sequences')
p <- p + geom_histogram(aes(fill = onlyDIAump), position = "dodge" )
p <- p + facet_grid(facets= . ~ specie)

print(p)
ggsave(filename="Figure5F_peptides.pdf", plot=p, width=7, height=7)
```

